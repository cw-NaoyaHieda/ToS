---
title: "市場リスク評価"
author: "Naoya Hieda"
date: "`r Sys.Date()`"
output:
  rmdformats::readthedown:
    highlight: kate
    number_sections: yes
    css: "/Users/naoya/Desktop/ToS/toc.css"
    toc_depth: 2
    pandoc_args: [
        "--from", "markdown+autolink_bare_uris+tex_math_single_backslash-implicit_figures"
        ]
---


```{r knitr_init, echo=FALSE, cache=FALSE}
library(knitr)
library(rmdformats)

## Global options
options(max.print="75")
opts_chunk$set(echo=TRUE,
	             cache=TRUE,
               prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE,
               fig.width=12,
               fig.height=9)
opts_knit$set(width=75)
set.seed(2017)
```


```{r package}
#実験で使う関数
source("/Users/naoya/Desktop/ToS/script/functions.R")
objects()
#パッケージのインストールと読み込み
#持ってないパッケージはインストールする
targetPackages <- c('zoo', 'xts','Quandl',
                    'quantmod','ggplot2','grid','reshape2','scales',
                    'dplyr','moments','xtable','gridExtra') 
newPackages <- targetPackages[!(targetPackages %in% installed.packages()[,"Package"])]
if(length(newPackages)) install.packages(newPackages, repos = "http://cran.us.r-project.org")
for(package in targetPackages) library(package, character.only = T)
```

# 株価収益率の分析

時刻$t$の金融資産価格を$P_t$とすると, 時刻$t-1$から時刻$t$にかけての資産価格変化率は

$$
R_t = \frac{P_t - P_{t-1}}{P_{t-1}} =  \frac{P_t}{P_{t-1}}-1 
$$

となる. この$R_t$を単純収益率と呼ぶが,小さな$x$の値に対して, $exp(x) \approx 1 + x$が成り立つことに注意すれば, 

$$
1+R_t = \frac{P_t}{P_{t-1}} \Leftrightarrow exp(R_t) \approx \frac{P_t}{P_{t-1}} 
$$

$r_t$の近似を$1+R_t$で表すとすれば
両辺の対数を取って 

$$
r_t = \log \left( \frac{P_t}{P_{t-1}} \right) = \log P_t - \log P_{t-1}
$$


と書くことができる. この対数価格の差分の系列$\{ r_t\}$を対数収益率とよび, 資産価格変化率を表すものである.

対数収益率を使うことにより, 多期間収益率を簡単に表すことができる. すなわち$k$期間の対数収益率は, １期間対数収益率の和で表現できる.

$$
r_{t+k}= \log \left( \frac{P_{t + k}}{P_t} \right) =  \log \left( \frac{P_{t + k}}{P_{t+k-1}}
\frac{P_{t + k-1}}{P_{t+k-2}}\cdots  + \frac{P_{t+1}}{P_{t}}
\right) =r_{t+k}+ \cdots r_{t+1}
$$

これより, 対数収益率の時系列が観測できれば、現時点$t$の金融資産$P_t$を用いて,将来時点$t+k$時点の金融資産価格は$P_{t+k}=P_t\exp(\sum_{k=1}^kr_{t+j})$と表すことができる.


このように, 金融資産価格の分析には対数収益率を用いることが通常である. 
日経２２５株価指数の時系列のプロットを出力する.

```{r n225}
#データの読み込み
n225 <- read.csv("/Users/naoya/Desktop/ToS/data/nikkei225.csv",skip=1)
y <- NULL
#終値(1日の最後の値段)を使う
y$Close <- n225$PX_LAST
#日付データをDate型に変換
y$ymd <- as.POSIXct(n225$Date)
#データフレームにする(行列の列に名前がついているもの)
#ggplotはdata.frameのデータにしか使えないので注意
df <-data.frame(dt=y$ymd, x=y$Close)
```

## 日経225<br>平均株価指数の遷移

```{r fig1}
#ggplotで日経平均株価をplot
#ggplotの各関数の意味は自分で調べること
ggplot(df,aes(x=dt,y=x))+geom_line()+
        scale_x_datetime(breaks = date_breaks("6 months"))+
        labs(y="N225")+
        theme_bw()+
  theme(axis.title.x = element_text(size=25),axis.title.y = element_text(size=25))+
  theme(axis.text.x = element_text(size=25),axis.text.y = element_text(size=25)) +
  theme(legend.title = element_text(size=15),legend.text = element_text(size=15))
```

## 日経平均の<br>対数収益率の推移

```{r fig2}
#日経平均の対数収益率をplot
df$log_x <- c(NA,diff(log(df$x))*100)
ggplot(df[-1,],aes(dt,log_x))+geom_line()+
        scale_x_datetime(breaks = date_breaks("6 months"))+
        labs(y="log return")+
        theme_bw()+
        theme(strip.background = element_blank(),
              panel.border = element_rect(colour = "black"))+
  theme(axis.title.x = element_text(size=25),axis.title.y = element_text(size=25))+
  theme(axis.text.x = element_text(size=25),axis.text.y = element_text(size=25)) +
  theme(legend.title = element_text(size=15),legend.text = element_text(size=15))
```


## 対数収益率の<br>基礎統計量

対数収益率について基礎統計量を計算し，ヒストグラムで確認する．

```{r summary}
#summaryはdata.frameに使うと[平均，最小値，最大値，25%点，50%点，75%点]を出力
summary(df)
#sd(x)でxの標準偏差
sd(df$log_x[-1])
ggplot(df,aes(x=log_x))+geom_histogram(binwidth = 1/5)+theme_bw()+
  theme(axis.title.x = element_text(size=25),axis.title.y = element_text(size=25))+
  theme(axis.text.x = element_text(size=25),axis.text.y = element_text(size=25)) +
  theme(legend.title = element_text(size=15),legend.text = element_text(size=15))
df[-1,][max(df$log_x[c(-1,-94,-276)])==df$log_x[-1],]
```


# 尺度変換した<br>　sin-arcsinh 分布


まずは，普通のsin-arcsinh分布

$$
f_s(x; \delta) =
\frac{\delta}{\sqrt{2 \pi (1+x^2)}}C(x; \delta) 
\exp
\left\{
-S(x;  \delta)^2/2
\right\}
%(a) fS (r1 ((x − \mu)/\sigma ; \lambda); \delta) (solid line), 
%(b) fS (r2 ((x − \mu)/\sigma ; \lambda); \delta)
$$
ここで$S(x;\delta)=\sinh^{-1}(\delta\sinh^{-1}(x))$, $C(x; \delta)=1+S(x;\delta)^2)^{1/2}$である.



sin-arcsinh$(\cdot)$の確認


```{r FAdist}
# density
dx <- seq(-8,8, length=1000)
plot_density <- data.frame(dx,delta_1=sapply(dx, dfas, delta=1),delta_.1=sapply(dx, dfas, delta=.1),
           delta_.5=sapply(dx, dfas, delta=.5),delta_2=sapply(dx, dfas, delta=2))
ggplot() + geom_line(data=plot_density %>% melt(id="dx"),aes(x=dx,y=value,color=variable),size=2)+
  theme_bw()+
  theme(legend.position = "bottom")+
  theme(axis.title.x = element_text(size=25),axis.title.y = element_text(size=25))+
  theme(axis.text.x = element_text(size=25),axis.text.y = element_text(size=25)) +
  theme(legend.title = element_text(size=25),legend.text = element_text(size=25))
```


* この分布にskewを入れる.

$$
\begin{align}
p(x; \lambda, \delta, \sigma) =
\frac{1}{\delta}f_s(r(x/\delta; \lambda))
\end{align}
$$

尺度変換した分布を確認する．

```{r FAdist4}
dx <- seq(-5,5, length=1000)
plot_1 <- data.frame(dx,
                     p_0=sapply(dx, dfas2,
                                mu=0.5, sigma=0.2, lambda=0, delta=0.5),
                     p_1=sapply(dx, dfas2,
                                mu=0.5, sigma=0.2, lambda=1, delta=0.5),
                     p_2 = sapply(dx, dfas2,
                                mu=0, sigma=0.2, lambda=2, delta=0.5),
                     p_3 = sapply(dx, dfas2,
                                mu=0.5, sigma=0.2, lambda=0.5, delta=0.5))
ggplot() + geom_line(data=plot_1 %>% melt(id="dx"),
                     aes(x=dx,y=value,color=variable),size=2)+
  xlim(-5,5) +  theme_bw() +
  theme(legend.position = "bottom")+
  theme(axis.title.x = element_text(size=25),axis.title.y = element_text(size=25))+
  theme(axis.text.x = element_text(size=25),axis.text.y = element_text(size=25)) +
  theme(legend.title = element_text(size=25),legend.text = element_text(size=25))
```

パラメータを適当にいじって，別varのプロット

```{r fig4_b}
dx <- seq(-5,5, length=1000)
plot_2 <- data.frame(dx,
                     p_0=sapply(dx, dfas2,
                                mu=0, sigma=0.2, lambda=0, delta=0.1),
                     p_1=sapply(dx, dfas2,
                                mu=0, sigma=0.2, lambda=.1, delta=0.1),
                     p_2 = sapply(dx, dfas2,
                                  mu=0, sigma=0.2, lambda=.2, delta=0.1),
                     p_3 = sapply(dx, dfas2,
                                  mu=0, sigma=0.2, lambda=0.5, delta=0.1))
ggplot() + geom_line(data=plot_2 %>% melt(id="dx"),
                     aes(x=dx,y=value,color=variable),size=1.2)+
  xlim(-5,5) +  theme_bw() +
  theme(legend.position = "bottom")+
  theme(axis.title.x = element_text(size=25),axis.title.y = element_text(size=25))+
  theme(axis.text.x = element_text(size=25),axis.text.y = element_text(size=25)) +
  theme(legend.title = element_text(size=25),legend.text = element_text(size=25))
```


# 最尤推定

尤度関数

$$
\ell(\theta) =  \sum_{i=1}^n \log f_{p}(r_{i}; \mu, \sigma, \lambda, \delta)
$$

最尤推定量（MLE）

$$
\hat{\theta} =\textrm{argmax}_{\theta}\ell(\theta)
$$


## 尺度変換した<br>sinh-arcsinh分布の<br>パラメータ推定

```{r MLE}
rt <- df$log_x[-1]
rt <- rt[rt!=0]
fit <- mle.dfas2(rt, ini=c(0, log(0.2), -0.2, 0.5))

fit$par2

df= data.frame(log_return=rt)
ggplot(df, aes(log_return))+
        geom_histogram(binwidth=.3, colour="black", fill="white",
                          aes(y=..density..))+
      #scale_fill_gradient("Count", low="#DCDCDC", high="#7C7C7C")+
       xlim(min(rt),max(rt))+
       stat_function(fun=dnorm,
                         #colour="violetred",
                         aes(colour ="Normal distribution"),
                         size=1,
                         n=401,
                         args=list(mean=mean(rt), sd = sd(rt)))+
       stat_function(fun=dfas2,
                         #colour="green",
                         aes(colour ="Tos sinh-arcsinh distribution"),
                         size=1,
                         n=401,
                         args=list(mu=fit$par2[1],
                                  sigma = fit$par2[2],
                                  lambda = fit$par2[3],
                                  delta = fit$par2[4]))+
        theme_bw()+
  theme(legend.position = "bottom")+
  theme(axis.title.x = element_text(size=25),axis.title.y = element_text(size=25))+
  theme(axis.text.x = element_text(size=25),axis.text.y = element_text(size=25)) +
  theme(legend.title = element_text(size=25),legend.text = element_text(size=25))
```


## モーメントの計算

大きさ$n$の標本データ$X_1, X_2, \ldots, X_n$から標本モーメントは次のようにして求める.

$$
\begin{align}
\bar{X} =& \frac{1}{n} \sum_{i=1}^n X_i \\
\hat{\sigma^2}=& \frac{1}{n-1}\sum_{i=1}^n (X_i -\bar{X})^2 \\
\hat{\beta}_1 =& \frac{1}{\hat{\sigma}^3} \frac{1}{n-1}\sum_{i=1}^n (X_i -\bar{X})^3 \\
\hat{\beta}_2 =& \frac{1}{\hat{\sigma}^4} \frac{1}{n-1}\sum_{i=1}^n (X_i -\bar{X})^4
\end{align}
$$



```{r moments}
# パラメータが与えられた時のFA分布について
out.mom <- fas2.moment(fit$par2)
# 表にする
hyou.a <- matrix(0, 3,4)
hyou.a[1,] <- c( mean(rt), sd(rt), skewness(rt), kurtosis(rt))
hyou.a[2,] <- c( mean(rt), sd(rt), 0, 3)
hyou.a[3,] <- c(out.mom$m1, sqrt(out.mom$v2), out.mom$b1, out.mom$b2)
dimnames(hyou.a) <- list( c("sample","N","FSA"), c("E(X)", "sqrt Var(X)", "beta1", "beta2"))
print(xtable(hyou.a, digits=3))
hyou.a
```


# 期待<br>　ショートフォールの計算

定理：平均$\mu$, 分散$\sigma^2$に従う確率変数$X \sim N(\mu, \sigma^2)$の$100(1-\alpha)$水準のESは次のようになる.

$$
ES_{\alpha} = -\mu +\frac{\sigma}{p}\phi(\Phi^{-1}(\alpha))
$$


証明:

条件付き確率の定義から

$$
\begin{align}
ES_{\alpha} =& - E[ X | X < -VaR(\alpha)] =
- \frac{E [X \cap X < -VaR(\alpha)] }{P(X < -VaR(\alpha))}\\
=&
-
\frac{1}{p}
\int_{-\infty}^{-VaR(\alpha)} x \frac{1}{\sqrt{2\pi}\sigma}
\exp\left\{-\frac{(x-\mu)^2}{2\sigma^2} \right\} dx
\end{align}
$$

変数変換$y=(x-\mu)/\sigma$を行うと, $dx = \sigma dy$, また,


$$
\begin{align}
ES_{\alpha} =&
-
\frac{1}{p}
\int_{-\infty}^{-VaR(\alpha)} x \frac{1}{\sqrt{2\pi}\sigma}
\exp\left\{-\frac{(x-\mu)^2}{2\sigma^2} \right\} dx \\
=&
-
\frac{1}{p}
 \frac{1}{\sqrt{2\pi}\sigma}\int_{-\infty}^{z_{\alpha}}
 (\mu+ \sigma y) 
 \exp\left\{-\frac{y^2}{2} \right\} \sigma dy  \\
 =&
 -
\frac{1}{p}
\int_{-\infty}^{z_{\alpha}}
 \frac{1}{\sqrt{2\pi}} \mu \exp\left\{-\frac{y^2}{2} \right\} dy  
-
\frac{\sigma}{p}
\int_{-\infty}^{z_{\alpha}} 
 \frac{1}{\sqrt{2\pi}} y \exp\left\{-\frac{y^2}{2} \right\} dy  \\
 =&
 -\mu + \frac{\sigma}{p} 
\left( \frac{1}{\sqrt{2\pi}} \exp\left\{-\frac{y^2}{2}\right\}
\right)_{-\infty}^{z_{\alpha}} = -\mu+\frac{\sigma}{p}\phi(z(\alpha))
\end{align}
$$

これより, $\mu=0$, $\sigma=1$の標準正規分布の場合$ES_{\alpha}= \frac{\phi(z(\alpha))}{p}$である.

```{r example}
#標準正規分布の場合
alpha = c(0.01, 0.025, 0.05)
VaR <- -qnorm(alpha)
ES <- dnorm(qnorm(alpha))/alpha
```

```{r plot}
alpha <- seq(1e-5, 0.05, length=100)
VaR <- -qnorm(alpha)
ES <- dnorm(qnorm(alpha))/alpha
matplot(alpha, cbind(VaR,ES), type="l")
```

```{r example2}
# mu=-0.1, sigma=1.5の場合
alpha = c(0.01, 0.025, 0.05)
VaR <- -qnorm(alpha, mean=-0.1, sd=1.5)
ES <- 0.1+dnorm(qnorm(alpha))*1.5/alpha
VaR
ES
# mu=0.1, sigma=1.5の場合
alpha = c(0.01, 0.025, 0.05)
VaR <- -qnorm(alpha, mean=0.1, sd=1.5)
ES <- -0.1+dnorm(qnorm(alpha))*1.5/alpha
ES
VaR
```



*　正規分布以外の分布で, 密度関数$f$, 分布関数$F$を持つ場合

$$
ES_{\alpha} = -\mu + \frac{f(F^{-1}(\alpha))}{\alpha}
$$


# sinh-arcsinh分布からの<br>　乱数生成<br>　(重点サンプリング)

```{r sinh-arcsin_r}
rand.fa<-rfa_SIR(n=10000, mu=fit$par2[1],
                                  sigma = fit$par2[2],
                                  lambda = fit$par2[3],
                                  delta = fit$par2[4])

ggplot()+geom_histogram(data=data.frame(sample=rand.fa$q),aes(x=sample),
                        binwidth = 14/100)+theme_bw()+
  theme(axis.title.x = element_text(size=25),axis.title.y = element_text(size=25))+
  theme(axis.text.x = element_text(size=25),axis.text.y = element_text(size=25)) +
  theme(legend.title = element_text(size=25),legend.text = element_text(size=25))
```

## 実際の分布との<br>比較

```{r sinh-arcsin_r2}
df <-data.frame(x=rand.fa$q)
f2 <- ggplot(df,aes(x=x))+
        geom_histogram(aes(y=..density.., fill=..count..),
          binwidth = .15, colour="black") +xlab("log return")+
         scale_fill_gradient("Count", low="#DCDCDC", high="#7C7C7C")+
        theme_bw()+
        theme(#panel.grid.major = element_blank(),
        #panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        panel.border = element_rect(colour = "black"),
        legend.title=element_blank(),legend.position="none")+
        stat_function(fun=dfas2,
                         #colour="violetred",
                         aes(colour ="red"),
                         size=1,
                         n=401,
                         args=list(mu=fit$par2[1],
                                  sigma = fit$par2[2],
                                  lambda = fit$par2[3],
                                  delta = fit$par2[4]))+
  theme(axis.title.x = element_text(size=25),axis.title.y = element_text(size=25))+
  theme(axis.text.x = element_text(size=25),axis.text.y = element_text(size=25)) +
  theme(legend.title = element_text(size=25),legend.text = element_text(size=25))

f2 
```



# FA分布の<br>　VaRとESの計算

## 分位点を計算する関数

```{r pfa2}
# 確率分布関数のプロット
dx <-seq(-6,6, by=0.01)
pval <- sapply(dx, pfa2, mu=fit$par2[1], sigma=fit$par2[2], lambda=fit$par2[3], delta = fit$par2[4]) 
plot(dx,pval, type="l")

#0が累積確率何%点か確認する
pfa2(0, mu=fit$par2[1], sigma=fit$par2[2], lambda=fit$par2[3], delta = fit$par2[4])

#97.5%点のx(対数収益率)を求める
qfas(0.025, mu=fit$par2[1], sigma=fit$par2[2], lambda=fit$par2[3], delta = fit$par2[4])

# 分位点関数のプロット
px <- seq(0.01, 0.99, by=0.005)
qval <- sapply(px, qfas, mu=fit$par2[1], sigma=fit$par2[2], lambda=fit$par2[3], delta = fit$par2[4]) 
plot(px,qval, type="l")
```

$\alpha=0.01, 0.025, 0.05$にしてVaRとESを推定する. 

## 真値を計算

```{r vares2}
#99%,97.5%,95%の各点に対して，先ほどの関数を用いて求める
VaR1.fa <- qfas(0.01, mu=fit$par2[1], sigma=fit$par2[2],
                lambda=fit$par2[3], delta = fit$par2[4])
VaR25.fa <- qfas(0.025, mu=fit$par2[1], sigma=fit$par2[2],
                 lambda=fit$par2[3], delta = fit$par2[4])
VaR5.fa <- qfas(0.05, mu=fit$par2[1], sigma=fit$par2[2],
                lambda=fit$par2[3], delta = fit$par2[4])
#まとめておく
VaR.true.FA <- c(VaR1.fa ,VaR25.fa ,VaR5.fa )

ES1.fa <- find.ES(p=0.01, par=fit$par2)
ES25.fa <- find.ES(p=0.025, par=fit$par2)
ES5.fa <- find.ES(p=0.05, par=fit$par2)
#まとめる
ES.true.FA <- c(ES1.fa ,ES25.fa ,ES5.fa )
ES.true.FA
```
## 単純<br>モンテカルロ法

```{r SMCforFAdistribution}
SMC.fa.out <- SMC.fa(fit$par2)
```


## IS(重点サンプリング)による<br>VaRとESを計算

```{r IS_FA}
# 99%,97.5%,95%それぞれのVaRと平均が一致するthetaを取得
theta.val1<- find.theta(0.01, fit$par2)
theta.val25<- find.theta(0.025, fit$par2)
theta.val5<- find.theta(0.05, fit$par2)

#97.5%点に関して一致することを確認
qfas(p=0.025, mu=fit$par2[1], sigma=fit$par2[2],
     lambda=fit$par2[3], delta=fit$par2[4])
mean.IS(theta.val25,par=fit$par2)

# 密度関数の確認
dx <- seq(-30,10,length=200)
out1 <- sapply(dx, d.IS, theta=theta.val1, par=fit$par2)
out25 <- sapply(dx, d.IS, theta=theta.val25, par=fit$par2)
out5 <- sapply(dx, d.IS, theta=theta.val5, par=fit$par2)
out <- cbind(out1,out25,out5)
#matplot(dx,out,type="l",lwd=2)
ggplot(data.frame(dx,out) %>% melt('dx'),
       aes(x=dx,y=value,colour=variable))+
  geom_line(size=2)+theme_bw()+
  theme(legend.position = "bottom")+
  theme(axis.title.x = element_text(size=25),axis.title.y = element_text(size=25))+
  theme(axis.text.x = element_text(size=25),axis.text.y = element_text(size=25)) +
  theme(legend.title = element_text(size=25),legend.text = element_text(size=25))


rfa.IS.1<-rIS_SIR(n=20000, par=fit$par2, par2=VaR.true.FA[1], theta=theta.val1)
#hist(rfa.IS.1$q, breaks=100)
ggplot(data.frame(q=rfa.IS.1[[1]]),aes(x=q))+
  geom_histogram()+theme()+theme_bw()+
  theme(axis.title.x = element_text(size=25),axis.title.y = element_text(size=25))+
  theme(axis.text.x = element_text(size=25),axis.text.y = element_text(size=25)) +
  theme(legend.title = element_text(size=25),legend.text = element_text(size=25))


rfa.IS.25<-rIS_SIR(n=20000, par=fit$par2, par2=VaR.true.FA[2], theta=theta.val25)
#hist(rfa.IS.25$q, breaks=100)
ggplot(data.frame(q=rfa.IS.25[[1]]),aes(x=q))+
  geom_histogram()+theme()+theme_bw()+
  theme(axis.title.x = element_text(size=25),axis.title.y = element_text(size=25))+
  theme(axis.text.x = element_text(size=25),axis.text.y = element_text(size=25)) +
  theme(legend.title = element_text(size=25),legend.text = element_text(size=25))


rfa.IS.5<-rIS_SIR(n=20000, par=fit$par2, par2=VaR.true.FA[3], theta=theta.val5)
#hist(rfa.IS.5$q, breaks=100)
ggplot(data.frame(q=rfa.IS.5[[1]]),aes(x=q))+
  geom_histogram()+theme()+theme_bw()+
  theme(axis.title.x = element_text(size=25),axis.title.y = element_text(size=25))+
  theme(axis.text.x = element_text(size=25),axis.text.y = element_text(size=25)) +
  theme(legend.title = element_text(size=25),legend.text = element_text(size=25))


# サンプリングしたものを入力としてFA分布の重点サンプリングを行う
rfa1 <- sample(rfa.IS.1$q, 10000)
rfa25 <- sample(rfa.IS.25$q, 10000)
rfa5 <- sample(rfa.IS.5$q, 10000)

out.fa <- IS.fa(7)
```


## FA分布の<br>ES,VARのSMC,ISの図<br>(収束の様子)

```{r figVaRggplot}
out <-data.frame(100:10000, -out.fa[[1]][,c(1,3,5)],-SMC.fa.out[[1]][,1:3])
names(out)<- c("N", "VaR99(IS)","VaR97.5(IS)","VaR95(IS)",
               "VaR99(SMC)","VaR97.5(SMC)","VaR95(SMC)")

df2=melt(out,id.vars=c("N"))

plot_b=ggplot(df2,aes(N,value,lty=variable,col=variable))+
  geom_line(size=.8)+geom_hline(aes(yintercept=-VaR.true.FA[1]))+
  geom_hline(aes(yintercept=-VaR.true.FA[2]))+
  geom_hline(aes(yintercept=-VaR.true.FA[3]))+
  theme_bw()+ylab("VaR")+
  theme(#panel.grid.major = element_blank(),
        #panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        panel.border = element_rect(colour = "black"),
        legend.title=element_blank(),legend.position="bottom")+
        theme(legend.key.width=unit(2.5,"cm"))+
  theme(strip.text.x=element_text(size=16))+
  theme(axis.title.x = element_text(size=25),axis.title.y = element_text(size=25))+
  theme(axis.text.x = element_text(size=25),axis.text.y = element_text(size=25)) +
  theme(legend.title = element_text(size=25),legend.text = element_text(size=25))
       
plot_b 
```

```{r figESggplot}
out <-data.frame(100:10000, -out.fa[[1]][,c(2,4,6)],-SMC.fa.out[[1]][,4:6])
names(out)<- c("N","ES99(IS)","ES97.5(IS)","ES95(IS)",
               "ES99(SMC)","ES97.5(SMC)","ES95(SMC)")

df2=melt(out,id.vars=c("N"))

plot_b=ggplot(df2,aes(N,value,lty=variable,col=variable))+
  geom_line(size=.8)+geom_hline(aes(yintercept=-ES.true.FA[1]))+
  geom_hline(aes(yintercept=-ES.true.FA[2]))+
  geom_hline(aes(yintercept=-ES.true.FA[3]))+
  theme_bw()+ylab("ES")+
        theme(#panel.grid.major = element_blank(),
        #panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        panel.border = element_rect(colour = "black"),
        legend.title=element_blank(),legend.position="bottom")+
        theme(legend.key.width=unit(2.5,"cm"))+
  theme(strip.text.x=element_text(size=16))+
  theme(axis.title.x = element_text(size=25),axis.title.y = element_text(size=25))+
  theme(axis.text.x = element_text(size=25),axis.text.y = element_text(size=25)) +
  theme(legend.title = element_text(size=25),legend.text = element_text(size=25))
plot_b
```





# 正規分布の<br>　VaRとESの推定

## 正規分布の場合:<br>(真値を計算)

```{r norm_answer}
# 正規分布の場合はパラメータは平均と分散だけ
theta <- c(mean(rt), sd(rt))
f <-　function(x)  x*dnorm(x,mean=theta[1], sd=theta[2]) 
VaR.true.norm <- qnorm(c(0.01,0.025,0.05), mean=theta[1], sd=theta[2])
ES.true.norm <- sapply( c(0.01,0.025, 0.05), function(x){
  integrate(f,
            lower=-Inf, upper=qnorm(x,mean=theta[1], sd=theta[2]))$value/x})
```

## 正規分布の場合：<br>(単純モンテカルロ法)

```{r varnormal}
SMC.norm.out <- SMC.norm(theta)
```

## 正規分布の場合：<br>重点サンプリング

```{r Var_normal_IS}
N <-10000
VaR.true <- qnorm(c(0.01,0.025,0.05), mean=theta[1], sd=theta[2])

theta <- c(mean(rt), sd(rt))

## IS for VaR
Expected.val.th <- function(VaR, mu, sd){
    #M <- exp(mu*th+ sd^2*th^2/2)
    #m <- mu+sd^2*th
    return( (VaR - mu)/sd^2 )}

th1 <- Expected.val.th(VaR=VaR.true[1], mu=theta[1], sd = theta[2])

dIS.norm <- function(x, mean, sd, th ) {
  M <- exp(mean*th+ sd^2*th^2/2)  
  dnorm(x, mean=mean, sd =sd) * exp(th*x)/M}

## 結局正規分布の場合は 平均をシフトさせるだけの演算
## dnorm(x , mean = mu+sd^2*th, sd= theta[2] )

##　重点分布からサンプリング
IS1 <- rnorm(10000, mean = theta[1]+theta[2]^2*th1, sd = theta[2])
hist(IS1, breaks=100, prob=TRUE)
dx <- seq(-10,10, length=1000)
lines(dx, sapply(dx, dIS.norm, mean = theta[1], sd = theta[2], th=th1),type="l")
lines(dx, sapply(dx, dnorm, mean = theta[1], sd = theta[2]),col=2)

## ウェイトの計算
M1 <- exp(theta[1]*th1+ theta[2]^2*th1^2/2)  
w1 <- exp(-th1*IS1)*M1

# サンプルと対応するweightをくっつける
out <- cbind( IS1,  w1/N)
A <- out[sort.list(out[,2]),]
A <- cbind(A, cumsum(A[,2]))
# VaR0.01の推定値 
A[which.min(abs(A[,3]-0.01)),]
# ES0.01の推定値
sum(apply(A[1:which.min(abs(A[,3]-0.01)),1:2],1,prod))/0.01 
out.norm <- IS.norm(theta)
```

## 正規分布の<br>ES,VARの図<br>(収束の様子)

```{r, plot1}
## normal VaR
out <-data.frame(c(100:10000),-out.norm[[1]][,c(1,3,5)],-SMC.norm.out[[1]][,1:3])
names(out)<- c("N","VaR0.01(IS)","VaR0.025(IS)","VaR0.05(IS)",
               "VaR0.01(SMC)","VaR0.025(SMC)","VaR0.05(SMC)")

df2=melt(out,id.vars=c("N"))

plot_b=ggplot(df2,aes(N,value,lty=variable,col=variable))+
  geom_line(size=.8)+geom_hline(aes(yintercept=-VaR.true.norm[1]))+
  geom_hline(aes(yintercept=-VaR.true.norm[2]))+
  geom_hline(aes(yintercept=-VaR.true.norm[3]))+
  theme_bw()+ylab("VaR")+
        theme(#panel.grid.major = element_blank(),
        #panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        panel.border = element_rect(colour = "black"),
        legend.title=element_blank(),legend.position="bottom")+
        theme(legend.key.width=unit(2.5,"cm"))+
  theme(strip.text.x=element_text(size=16))+
  theme(axis.title.x = element_text(size=25),axis.title.y = element_text(size=25))+
  theme(axis.text.x = element_text(size=25),axis.text.y = element_text(size=25)) +
  theme(legend.title = element_text(size=25),legend.text = element_text(size=25))
plot_b


## normal ES
out2 <-data.frame(c(100:10000),-out.norm[[1]][,c(2,4,6)],-SMC.norm.out[[1]][,4:6])
names(out2)<- c("N","ES0.01(IS)","ES0.025(IS)","ES0.05(IS)",
               "ES0.01(SMC)","ES0.025(SMC)","ES0.05(SMC)")

df2=melt(out2,id.vars=c("N"))

plot_b=ggplot(df2,aes(N,value,lty=variable,col=variable))+
  geom_line(size=.8)+geom_hline(aes(yintercept=-ES.true.norm[1]))+
  geom_hline(aes(yintercept=-ES.true.norm[2]))+
  geom_hline(aes(yintercept=-ES.true.norm[3]))+
  theme_bw()+ylab("ES")+
        theme(#panel.grid.major = element_blank(),
        #panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        panel.border = element_rect(colour = "black"),
        legend.title=element_blank(),legend.position="bottom")+
        theme(legend.key.width=unit(2.5,"cm"))+
  theme(strip.text.x=element_text(size=16))+
  theme(axis.title.x = element_text(size=25),axis.title.y = element_text(size=25))+
  theme(axis.text.x = element_text(size=25),axis.text.y = element_text(size=25)) +
  theme(legend.title = element_text(size=25),legend.text = element_text(size=25))
plot_b
```

## 結果のまとめ

```{r result.table}
hyou1 <- matrix(0,6,6)
hyou1[1,] <- c( VaR.true.norm, ES.true.norm)
hyou1[2,] <- out.norm[[1]][9901,][c(1,3,5,2,4,6)]
hyou1[3,] <-SMC.norm.out[[1]][9901,]
hyou1[4,] <-c( VaR.true.FA, ES.true.FA)
hyou1[5,] <- out.fa[[1]][9901,][c(1,3,5,2,4,6)]
hyou1[6,] <-SMC.fa.out[[1]][9901,]

dimnames(hyou1) <- list(rep(c("True", "IS","SMC"),2), 
                      c("VaR99","VaR97.5","VaR95",
                       "ES99","ES97.5","ES95"))
#print(xtable(hyou1, digit=3)) TeXでレポートを書く場合はxtableを使う
hyou1
```

#課題 

## 課題1 {.tabset .tabset-fade}

### 課題
成功確率$p$の幾何分布($f(x)=pq^{x−1}$のモーメント母関数を求めよ.また，原点周りの1次と2次のモーメントを求めよ．

### 答え

$$M_X(t)=\frac{pe^t}{1-qe^t}$$

## 課題2 {.tabset .tabset-fade}

### 課題 

本実験では，N225の対数収益率に，正規分布と$F_{SA}$分布に従っていると仮定したときのパラメータを推定した．各分布について，推定したパラメータの分布の2.5\%分位点より，低い値を観測した対数収益率の平均と最大値を求めよ．

### 答え

```{r,echo=FALSE}
library(formattable)#課題に関係ない
#データの読み込み
n225 <- read.csv("nikkei225.csv",skip=1)
y <- NULL
#終値(1日の最後の値段)を使う
y$Close <- n225$PX_LAST
#日付データをDate型に変換
y$ymd <- as.POSIXct(n225$Date)
#データフレームにする(行列の列に名前がついているもの)
#ggplotはdata.frameのデータにしか使えないので注意
df <-data.frame(dt=y$ymd, x=y$Close)
df$log_x <- c(NA,diff(log(df$x))*100)
n_25 <- qnorm(0.025,mean(df$log_x,na.rm = T),sd(df$log_x,na.rm = T))
fa_25 <- qfas(0.025, mu=fit$par2[1], sigma=fit$par2[2], lambda=fit$par2[3], delta = fit$par2[4])
formattable::formattable(data.frame(
  norm=mean(df$log_x[df$log_x < n_25],na.rm = T),
  F_sa=mean(df$log_x[df$log_x < fa_25],na.rm = T)))
```

## 課題3 {.tabset .tabset-fade}

### 課題

配布データ"課題3.csv"は，あるパラメータの正規分布から発生している．パラメータを最尤法によって推定し，データのヒストグラムと分布を重ね合わせた図を作成せよ．

### 答え
```{r,echo=FALSE}
data <- read.csv("課題3.csv")
mu <- mean(data$norm_data)
sigma <- sd(data$norm_data)
ggplot(data, aes(x=norm_data))+
        geom_histogram(binwidth=.3, colour="black", fill="white",
                          aes(y=..density..))+
      #scale_fill_gradient("Count", low="#DCDCDC", high="#7C7C7C")+
       stat_function(fun=dnorm,
                         #colour="violetred",
                         aes(colour ="Normal distribution"),
                         size=1,
                         n=401,
                         args=list(mean=mu, sd = sigma))+
  theme_bw()+
  theme(axis.title.x = element_text(size=25),axis.title.y = element_text(size=25))+
  theme(axis.text.x = element_text(size=25),axis.text.y = element_text(size=25)) +
  theme(legend.title = element_text(size=25),legend.text = element_text(size=25))
```

## 課題4 {.tabset .tabset-fade}

### 問題

ポアソン分布$f(x) = \frac{\lambda e^{-\lambda}}{x!}$の$(\lambda=4)$での$(x\geq19)$の確率を理論値を求め、単純モンテカルロ法と重点サンプリングによる推定値を求めよ(ただし、ポアソン分布のモーメント母関数は$M(\theta)=e^{\lambda (e^{\theta}-1)}$であり、授業中に行った指数変換によって適切な重点分布を求める事)

### 解答

```{r,echo=FALSE}
# Simple Monte Carlo Method
sim.SMC <-function(Nsim, lambda, X){
  x <- rpois(n = Nsim, lambda = lambda)
  out <- sum( x >=X )/Nsim 
  return(out)}

Nsim <- c(100,1000,2000,3000)
hyou.c <- matrix(0, 2, 4)
dimnames(hyou.c) <- list(c("平均","標準偏差"), Nsim)
k<- 1
for(i in Nsim){
  kekka <-replicate(1000, sim.SMC(i, X=19, lambda=4))
  hyou.c[,k] <- c(mean(kekka), sd(kekka)) 
  k<- k+1}


#重点サンプリング
sim.IS <-function(Nsim, lambda, X, theta){
  x <- rpois(n=Nsim,lambda = lambda*exp(theta))
  out <- mean((x >=X )*(exp(lambda*(exp(theta)-1))/exp(theta*(x))))
  return(out)}

hyou.b <- matrix(0, 2, 4)
dimnames(hyou.b) <- list(c("平均","標準偏差"), Nsim)
k<- 1
for(i in Nsim){
  kekka <-replicate(1000, sim.IS(i, lambda=4,X=19, theta=log(19/4)))
  hyou.b[,k] <- c(mean(kekka), sd(kekka)) 
  k<- k+1}


# 答えを確認する
prob <- 1-ppois(18,4)
formattable::formattable(data.frame(hyou.c))
formattable::formattable(data.frame(hyou.b))
prob

```



## 課題5 {.tabset .tabset-fade}

### 問題

尺度変換を伴う$F_{SA}$分布のVaR,ESについて，本実験で求めた結果には，ばらつきが存在する．97.5\%VaRとESについて，N=100,1000,10000で20回計算した結果の平均と標準偏差を求めよ．配布したコードのIS.fa_25()という関数が何をやっているか必ず書いてくること
<font color="red">(必ず考察を書いてくること)</font>

### 解答

```{r,echo=FALSE}
 f <- function(x, theta, par){
  exp(theta*x)*dfas2(x, mu=par[1], sigma=par[2],
                     lambda=par[3], delta=par[4])
}
M25 <- integrate(f, -30, 30, theta=theta.val25, par=fit$par2)$value
IS.fa_25 <- function(){

    out25<-cbind( rfa25[1:N],  w25[1:N]/N)
    A <- out25[sort.list(out25[,1]),]
    A <- cbind(A, cumsum(A[,2]))
    v25<-A[which.min(abs(A[,3]-0.025)),1]
    es25<-   sum(apply(A[1:which.min(abs(A[,3]-0.025)),1:2],1,prod))/0.025

  return(c(v25,es25))
}

kadai <- c()
for(N in c(100,1000,10000)){
out.fa <- NULL
for(i in 1:20){
  rfa.IS.25<-rIS_SIR(n=N*2, par=fit$par2, par2=VaR.true.FA[2], theta=theta.val25)
  rfa25 <- sample(rfa.IS.25$q, N)
  w25 <- exp(-theta.val25*rfa25)*M25
  out.fa <- rbind(out.fa,IS.fa_25())
}
kadai <- rbind(kadai,data.frame(mean(out.fa),sd(out.fa)))
}
colnames(kadai) <- c("mean","sd")
rownames(kadai) <- c(100,1000,10000)
formattable::formattable(kadai)
```


